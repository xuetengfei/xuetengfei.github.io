HTTP 是个应用层协议,几乎所有的 HTTP 通信都是由 TCP/IP 来承载的,HTTP 无需操心网络
通信的具体细节，它把联网的细节都交给了传输协议 TCP/IP。HTTP 连接实际上就是 TCP
连接及其使用规则。

TCP/IP 是全球计算机及网络设备都在使用的一种常用的分组交换网络分层协议集。TCP 为
HTTP 提供了一条可靠的比特传输管道。就像是漫威中雷神他们家有一个彩虹传输桥。

<img src='https://loremxuetengfei.oss-cn-beijing.aliyuncs.com/color-brdge-1548648413.jpg'/>

客户端应用程序可以打开一条 TCP/IP 连接，连接到可能运行在世界任何地方的服务器应用
程序。一旦连接建立起来了，在客户端和服务器的计算机之间交换的报文从 TCP 连接一端
传入从另一端以原有的顺序、正确地传送出来，永远不会丢失、受损或失序。

<img src='https://loremxuetengfei.oss-cn-beijing.aliyuncs.com/tcp-1548646792.jpg'/>

## 连接、IP、地址、端口号

在 HTTP 客户端向服务器发送报文之前，需要用`IP地址`和`端口号`在客户端和服务器之间
建立一条 TCP/IP 连接。

建立一条 TCP 连接的过程与给公司办公室的某个人打电话的过程类似。首先，要拨打公司
的电话号码。这样就能进入正确的机构了。其次，拨打要联系的那个人的分机号。

在 TCP 中，你需要知道服务器的 TCP 端口号。地址，以及与服务器上运行的特定软件相关
的 TCP 端口号。但最初怎么获得 HTTP 服务器的 IP 地址和端口号呢？当然是通过 URL 了
！我们前面曾提到过，URL 就是资源的地址，所以自然能够为我们提供存储资源的机器的
IP 地址。

<img src='https://loremxuetengfei.oss-cn-beijing.aliyuncs.com/tcp-ip-1548646272.jpg'/>

## Telnet 的实例

由于 HTTP 使用了 TCP/IP 传输协议，而且它是基于文本的，没有使用那些难以理解的二进
制格式，因此很容易直接与 Web 服务器进行对话。Telnet 程序可以将键盘连接到某个目标
TCP 端口，并将此 TCP 端口的输出回送到显示屏上。Telnet 常用于远程终端会话，但它几
乎可以连接所有的 TCP 服务器，包括 HTTP 服务器。可以通过 Telnet 程序直接与 Web 服
务器进行对话。通过 Telnet 可以打开一条到某台机器上某个端口的 TCP 连接，然后直接
向那个端口输入一些字符。Web 服务器会将 Telnet 程序作为一个 Web 客户端来处理，所
有回送给 TCP 连接的数据都会显示在屏幕上。

## 建立 TCP 连接需要三次握手

```bash
A:我喜欢你
B:我也喜欢你
A:那咱们在一起吧
```

TCP 连接的建立(三次握手): 从 Close 状态到 Establish 状态。最开始的时候客户端和服
务器都是处于 CLOSED 状态。`主动打开连接的为客户端，被动打开连接的是服务器。` Tcp
使用三次握手来创建一个新连接。

1. 发送方选择一个随机生成的序列号 "x" ，并向接收方发送一个 SYN 包
2. 接收方增加 "x" ，选择一个随机生成的序列号 "y" ，并发送一个 syn / ack 包
3. 发送方使用 ACK 数据包和应用程序数据的前个字节增加序列号和应答

Tcp 使用序列号来确保数据按顺序发送且没有漏洞。

<img src='https://loremxuetengfei.oss-cn-beijing.aliyuncs.com/tcp-1572511244.png'/>
<img src='https://loremxuetengfei.oss-cn-beijing.aliyuncs.com/tcp-3-1556503245.gif'/>

## 为什么 TCP 客户端最后还要发送一次确认呢？

一句话，主要防止已经失效的连接请求报文突然又传送到了服务器，从而产生错误。

如果使用的是两次握手建立连接，假设有这样一种场景，客户端发送了第一个请求连接并且
没有丢失，只是因为在网络结点中滞留的时间太长了，由于 TCP 的客户端迟迟没有收到确
认报文，以为服务器没有收到，此时重新向服务器发送这条报文，此后客户端和服务器经过
两次握手完成连接，传输数据，然后关闭连接。此时此前滞留的那一次请求连接，网络通畅
了到达了服务器，这个报文本该是失效的，但是，两次握手的机制将会让客户端和服务器再
次建立连接，这将导致不必要的错误和资源的浪费。

如果采用的是三次握手，就算是那一次失效的报文传送过来了，服务端接受到了那条失效报
文并且回复了确认报文，但是客户端不会再次发出确认。由于服务器收不到确认，就知道客
户端并没有请求连接。

## 断开 TCP 连接需要四次挥手

?> TCP 连接的释放(四次挥手): 从 Establish 状态到 Close 状态。

数据传输完毕后，双方都可释放连接。最开始的时候，客户端和服务器都是处于
ESTABLISHED 状态，然后客户端主动关闭，服务器被动关闭。

```bash
A:咱们分手吧
B:你确定吗?
B:那好吧,再见
A:再见
```

## 为什么建立连接是三次握手，关闭连接确是四次挥手呢？

建立连接的时候， 服务器在 LISTEN 状态下，收到建立连接请求的 SYN 报文后，把 ACK
和 SYN 放在一个报文里发送给客户端。而关闭连接时，服务器收到对方的 FIN 报文时，仅
仅表示对方不再发送数据了但是还能接收数据，而自己也未必全部数据都发送给对方了，所
以己方可以立即关闭，也可以发送一些数据给对方后，再发送 FIN 报文给对方来表示同意
现在关闭连接，因此，己方 ACK 和 FIN 一般都会分开发送，从而导致多了一次。

---

1. [TCP 的那些事儿（上）](https://coolshell.cn/articles/11564.html)
2. [TCP 的那些事儿（下）](https://coolshell.cn/articles/11609.html)
